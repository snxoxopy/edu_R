
# p209 데이터 분석 프로젝트
rm(list=ls())
# Data 준비
# 한국복지패널>Data
# https://www.koweps.re.kr:442/data/data/list.do
# packages 설치 및 로드
#install.packages("foreign")
library(foreign)#SPSS파일로드드
library(dplyr)
library(ggplot2)
library(readxl)

# Data 불러오기
setwd("C:\\r_suzin\\Data")
raw_welfare <- read.spss(file = "Koweps_hpc10_2015_beta1.sav", to.data.frame = T)
df_welfare <-  raw_welfare


# Data 검토
head(df_welfare)
# h10_id h10_ind h10_sn h10_merkey h_new h10_cobf h10_reg5 h10_reg7 h10_din h10_cin h10_flag
# 1      1       1      1      10101     0       NA        1        1     864     864        0
# p10_wgl   p10_wsl  p10_wgc   p10_wsc h10_hc nh1001_1 nh1001_2 h1001_1 h10_pind h10_pid
# 1 776.9947 0.2567795 763.7189 0.2523922      2       NA       NA       1        1     101
# ...(생략)
# [ reached 'max' / getOption("max.print") -- omitted 5 rows ]

tail(df_welfare)
View(df_welfare)
dim(df_welfare)
str(df_welfare)
# 'data.frame':	16664 obs. of  957 variables:
#   $ h10_id          : num  1 2 3 4 4 6 6 6 6 6 ...
# $ h10_ind         : num  1 1 1 1 1 1 1 1 1 1 ...
# $ h10_sn          : num  1 1 1 1 1 1 1 1 1 1 ...
# $ h10_merkey      : num  10101 20101 30101 40101 40101 ...
# $ h_new           : num  0 0 0 0 0 0 0 0 0 0 ...
# $ h10_cobf        : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h10_reg5        : num  1 1 1 1 1 1 1 1 1 1 ...
# $ h10_reg7        : num  1 1 1 1 1 1 1 1 1 1 ...
# $ h10_din         : num  864 600 1571 3579 3579 ...
# $ h10_cin         : num  864 600 1619 3687 3687 ...
# $ h10_flag        : num  0 0 0 0 0 0 0 0 0 0 ...
# $ p10_wgl         : num  777 960 1059 1012 1075 ...
# $ p10_wsl         : num  0.257 0.317 0.35 0.334 0.355 ...
# $ p10_wgc         : num  764 949 1048 992 1057 ...
# $ p10_wsc         : num  0.252 0.314 0.346 0.328 0.349 ...
# $ h10_hc          : num  2 2 1 1 1 1 1 1 1 1 ...
# $ nh1001_1        : num  NA NA NA NA NA NA NA NA NA NA ...
# $ nh1001_2        : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h1001_1         : num  1 1 1 2 2 5 5 5 5 5 ...
# $ h10_pind        : num  1 1 1 1 4 1 1 1 1 1 ...
# $ h10_pid         : num  101 201 301 401 402 601 602 603 604 605 ...
# $ h10_g1          : num  1 1 1 1 2 1 2 3 4 5 ...
# $ h10_g2          : num  10 10 10 10 2 10 20 11 1 2 ...
# $ h10_g3          : num  2 2 1 1 2 1 2 2 1 2 ...
# $ h10_g4          : num  1936 1945 1948 1942 1923 ...
# $ h10_g6          : num  2 4 3 7 2 6 5 3 4 4 ...
# $ h10_g7          : num  0 5 5 3 0 5 5 1 5 5 ...
# $ h10_g8          : num  0 0 0 0 0 0 0 0 0 0 ...
# $ h10_g9          : num  0 0 0 0 0 0 0 0 0 0 ...
# $ h10_g10         : num  2 2 2 3 2 1 1 0 1 1 ...
# $ h10_g11         : num  2 2 2 1 1 1 1 1 1 1 ...
# $ h10_g12         : num  1 1 1 1 1 1 1 1 1 1 ...
# $ h1001_110       : num  1 1 1 5 5 5 5 5 5 5 ...
# $ h1001_5aq1      : num  0 0 0 0 0 0 0 0 0 0 ...
# $ h1001_5aq2      : num  0 0 0 0 0 0 0 0 0 0 ...
# $ h1001_5aq3      : num  0 0 0 0 0 0 0 0 0 0 ...
# $ h1001_5aq4      : num  0 0 0 0 0 0 0 0 0 0 ...
# $ h10_med1        : num  1 1 1 1 2 1 2 3 4 5 ...
# $ h10_med2        : num  3 4 3 3 4 3 5 2 3 3 ...
# $ h10_med3        : num  60 28 12 3 6 5 0 3 0 14 ...
# $ h10_med4        : num  0 0 0 0 0 0 5 0 0 0 ...
# $ h10_med5        : num  0 0 0 0 0 0 23 0 0 0 ...
# $ h10_med6        : num  0 0 0 0 0 0 1 0 0 0 ...
# $ h10_med7        : num  3 2 2 1 1 2 1 2 0 2 ...
# $ h10_med8        : num  0 1 0 1 1 1 1 0 0 1 ...
# $ h10_g9_1        : num  3 3 3 3 3 3 3 0 0 3 ...
# $ h10_med9        : num  8 5 7 3 15 23 1 0 0 6 ...
# $ h10_med10       : num  0 0 0 0 0 1 1 1 0 0 ...
# $ h10_eco1        : num  1 1 1 1 2 1 2 3 4 5 ...
# $ h10_eco2        : num  2 3 1 1 3 1 1 0 3 3 ...
# $ h10_eco3        : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h10_eco4        : num  9 9 2 2 9 6 9 NA 9 9 ...
# $ h10_eco4_1      : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h10_eco5_1      : num  NA NA 1 1 NA NA NA NA NA NA ...
# $ h10_eco6        : num  NA NA 2 2 NA NA NA NA NA NA ...
# $ h10_eco_7_1     : num  NA NA 1 1 NA NA NA NA NA NA ...
# $ h10_eco_7_2     : num  NA NA 2 2 NA NA NA NA NA NA ...
# $ h10_eco_7_3     : num  NA NA 1 3 NA NA NA NA NA NA ...
# $ h10_eco8        : num  NA NA 75 42 NA 46 NA NA NA NA ...
# $ h10_eco9        : num  NA NA 942 762 NA 530 NA NA NA NA ...
# $ h10_eco10       : num  NA NA 3 2 NA 1 NA NA NA NA ...
# $ h10_eco11       : num  10 10 NA NA 10 NA 6 NA 10 10 ...
# $ h10_soc1        : num  1 1 1 1 2 1 2 3 4 5 ...
# $ h10_soc_2       : num  0 0 0 1 0 2 0 0 0 0 ...
# $ h10_soc_3       : num  NA NA NA NA NA 1 NA NA NA NA ...
# $ h10_soc_4       : num  NA NA NA NA NA 2 NA NA NA NA ...
# $ h10_soc_5       : num  NA NA NA NA NA 1 NA NA NA NA ...
# $ h10_soc_6       : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h10_soc_7       : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h10_soc_8       : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h10_soc_9       : num  NA NA NA NA NA 0 NA NA NA NA ...
# $ h10_soc_10      : num  NA NA NA NA NA 0 NA NA NA NA ...
# $ h10_soc_11      : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h10_soc8        : num  0 0 1 2 0 0 0 0 0 0 ...
# $ h10_soc9        : num  0 0 1 2 0 0 0 0 0 0 ...
# $ h10_soc11       : num  0 0 2 2 0 0 0 0 0 0 ...
# $ h10_soc10       : num  0 0 2 2 0 0 0 0 0 0 ...
# $ h10_soc_12      : num  4 4 4 4 4 4 4 4 4 4 ...
# $ h10_soc_13      : num  4 4 1 3 4 3 4 4 4 4 ...
# $ h1005_1         : num  1 1 1 1 1 1 1 1 1 1 ...
# $ h1005_3aq1      : num  2 2 1 2 2 2 2 2 2 2 ...
# $ h1005_2         : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h1005_3         : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h1005_4         : num  2 2 2 2 2 2 2 2 2 2 ...
# $ h1005_5         : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h1005_6         : num  NA NA NA NA NA NA NA NA NA NA ...
# $ h1005_7         : num  0 0 0 0 0 1 1 1 1 1 ...
# $ nh1005_8        : num  4 3 3 3 3 3 3 3 3 3 ...
# $ nh1005_9        : num  5 4 3 3 3 4 4 4 4 4 ...
# $ h1005_3aq2      : num  0 0 0 0 0 11 11 11 11 11 ...
# $ h1006_aq1       : num  2 2 2 2 2 2 2 2 2 2 ...
# $ h1006_1         : num  2 2 2 1 1 2 2 2 2 2 ...
# $ h1006_2         : num  3 3 1 3 3 3 3 3 3 3 ...
# $ h1006_4         : num  2 3 1 3 3 3 3 3 3 3 ...
# $ h1006_5         : num  33 198 23 73 73 82 82 82 82 82 ...
# $ h1006_3         : num  2 1 3 1 1 1 1 1 1 1 ...
# $ h1006_6         : num  5000 60000 200 20000 20000 50700 50700 50700 50700 50700 ...
# $ h1006_8         : num  1 1 1 1 1 1 1 1 1 1 ...
# $ h1006_9         : num  88 4 88 88 88 88 88 88 88 88 ...
# [list output truncated]
summary(df_welfare)


# 변수명 바꾸기

df_welfare <- rename(df_welfare, 
                     sex = h10_g3,
                     birth = h10_g4,
                     marriage = h10_g10,
                     religion = h10_g11,
                     income = p1002_8aq1,
                     code_job = h10_eco9,
                     code_region = h10_reg7)


# 데이터 분석 절차 1. 변수 검토 및 전처리 2. 변수 간 관계 분석

# p213 9-2 성별에 따른 월급 차이

## 1. 변수 검토하기
class(df_welfare)
# [1] "data.frame"

table(df_welfare$sex)
# table은 factor 자료형에 대해서 분석
# 1    2 
# 7578 9086 

## 2. 전처리
# 이상치 결측 처리
df_welfare$sex <-  ifelse(df_welfare$sex == 9, NA, df_welfare$sex)
# 결측치 확인
table(is.na(df_welfare$sex))
#FALSE 
#16664 

# 성별 항목 이름 부여
df_welfare$sex <-  ifelse(df_welfare$sex == 1, "male", "female")
table(df_welfare$sex)
# female   male 
# 9086   7578 

qplot(df_welfare$sex)

# 월급변수 검토 및 전처리

## 1. 변수 검토하기
class(df_welfare$income)
# [1] "numeric"

summary(df_welfare$income)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#     0.0   122.0   192.5   241.6   316.6  2400.0   12030 

qplot(df_welfare$income)

qplot(df_welfare$income) + xlim(0, 1000)

## 2. 전처리

## 이상치 확인
summary(df_welfare$income)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#     0.0   122.0   192.5   241.6   316.6  2400.0   12030 

## 이상치 결측 처리
df_welfare$income  <- ifelse(df_welfare$income %in% c(0,9999), NA, df_welfare$income)

## 결츨치 확인
table(is.na(df_welfare$income))
# FALSE  TRUE 
# 4620 12044 


# p218 성별에 따른 월급 차이 분석하기
## 1. 성별 월급 평균표 만들기
sex_income <-  df_welfare %>% 
  filter(!is.na(income)) %>% 
  group_by(sex) %>% 
  summarise(mean_income = mean(income))

?summary
?summarise

sex_income
# A tibble: 2 x 2
# sex    mean_income
# <chr>        <dbl>
#   1 female        163.
# 2 male          312.

## 2. 그래프 만들기
ggplot(data = sex_income, aes(x=sex, y = mean_income)) + geom_col()

?aes
?geom_col() #막대그래프, 정보쌓기

# p220 9-3 나이와 월급의 관계
## 1. 변수 검토하기
class(df_welfare$birth)
# [1] "numeric"

summary(df_welfare$birth)
#Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#1907    1946    1966    1968    1988    2014 

qplot(df_welfare$birth)

## 2. 전처리

# 이상치 확인
summary(df_welfare$birth)
#Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#1907    1946    1966    1968    1988    2014 

#결측치 확인
table(is.na(df_welfare$birth))
# FALSE 
# 16664 

# 이상치 결측 처리
df_welfare$birth <- ifelse(df_welfare$birth == 9999, NA, df_welfare$birth)
table(is.na(df_welfare$birth))
# FALSE 
# 16664 

## 3.파생변수 만들기 - 나이
# 2015년에 조사가 진행되었음
df_welfare$age <-  2015 - df_welfare$birth + 1
summary(df_welfare$age)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 2.00   28.00   50.00   48.43   70.00  109.00 

qplot(df_welfare$age)


# p223 나이와 월급의 관계 분석하기 
## 1. 나이에 따른 월급 평균표 만들기
age_income <-  df_welfare %>% 
  filter(!is.na(income)) %>% 
  group_by(age) %>% 
  summarise(mean_income = mean(income))


head(age_income)
# A tibble: 6 x 2
# age mean_income
# <dbl>       <dbl>
#   1    20        121.
# 2    21        106.
# 3    22        130.
# 4    23        142.
# 5    24        134.
# 6    25        145.

#@ 2. 그래프 만들기
ggplot(data = age_income, aes(x=age, y=mean_income)) + geom_line()

# p225 9-4 연령대에 따른 월급차이

# 연령대 변수 검토 및 전처리하기
## 1. 파생변수 만들기 - 연령대
df_welfare <-  df_welfare %>% 
  mutate(ageg = ifelse(age<30, "under 30", ifelse(age <= 59, "under 60", "over")))

table(df_welfare$ageg)
# over under 30 under 60 
# 6281     4334     6049 

qplot(df_welfare$ageg)

# 연령대에 따른 월급 차이 분석하기

## 1. 연령대별 월급 평균표
ageg_income <-  df_welfare %>% 
  filter(!is.na(income)) %>% 
  group_by(ageg) %>% 
  summarise(mean_income = mean(income))

ageg_income
# A tibble: 3 x 2
# ageg     mean_income
# <chr>          <dbl>
#   1 over            125.
# 2 under 30        164.
# 3 under 60        282.

## 2. 그래프 만들기
ggplot(data=ageg_income, aes(x=ageg, y=mean_income,)) + geom_col()
?geom_col()

ggplot(data=ageg_income, aes(x=ageg, y=mean_income)) +
  geom_col() +
  scale_x_discrete(limits = c("under 30", "under 60", "over"))
