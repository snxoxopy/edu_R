---
title: ğŸ¥ì˜í™” ì¶”ì²œì‹œìŠ¤í…œ ëª¨ë¸ êµ¬ì¶•
author: <p align="right"> 2ì¡° </p>
date: <p align="right"> `r format(Sys.Date())` </p>
output:
  html_document:
    theme: cosmo
    highlight: textmate
    toc: yes
    toc_depth: 4
    toc_float: yes
    code_folding: hide
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=T, fig.align = "center", message=F, warning=F, fig.height = 3, fig.width = 4, cache=T, dpi = 300, dev = "png")
```

# 1. ì˜í™” ë°ì´í„° ë¶„ì„
## 1.1. ë¬´ë¹„ë Œì¦ˆ ë°ì´í„°
```{r í™˜ê²½ì„¤ì •}
setwd("C:\\r_suzin\\PRJ")
#ë¼ì´ë¸ŒëŸ¬ë¦¬ ------------------------
#ì „ì²˜ë¦¬
library(data.table)
library(tidyverse)
library(lubridate)
library(dplyr)
library(naniar)
library(skimr)
#ì‹œê°í™”
library(ggplot2)
library(ggthemes)
library(multilinguer)
library(RColorBrewer)
library(wordcloud)
#ì¶”ì²œì•Œê³ ë¦¬ì¦˜
library(recommenderlab)

#ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° -------------------
movies <- read.csv('./data/movies.csv',header=T)
ratings <- read.csv('./data/ratings.csv',header=T) 
tags <- read.csv('./data/tags.csv',header=T)

View(ratings)
find_mvs <- which(ratings$userId == "610")
find_mvs
find_mvs2 <- ratings$movieId[find_mvs]
find_rt <- as.data.frame(ratings$rating[find_mvs])
View(find_rt)
print(find_rt)
str(find_rt)
idx = 0
idx2 = 0
for (mvids in movies$movieId)
{
  idx = idx + 1
  for (mvs610 in find_mvs2)
  {
    
      if (mvs610 == mvids){
        idx2 = idx2 + 1
        cat(movies$title[idx],"-" , find_rt[idx2,1],"\n")
      }
    
  }
  
}

find610_summary <- ratings %>% filter(userId == 610) %>% summarise(movieId)
str(find610_summary)


find610_gt4 <- ratings %>% filter(userId == 610 & rating>=4)
View(find610_gt4)
find610_gt4_mvid <- find610_gt4$movieId
find610_gt4_idxtitles <- which(movies$movieId %in% find610_gt4_mvid)
find610_gt4_titles <- movies$title[find610_gt4_idxtitles]
print(find610_gt4_titles)

find610_lt2 <- ratings %>% filter(userId == 610 & rating<=2)
find610_lt2_mvid <- find610_lt2$movieId
find610_lt2_idxtitles <- which(movies$movieId %in% find610_lt2_mvid)
find610_lt2_titles <- movies$title[find610_lt2_idxtitles]
print(find610_lt2_titles)



idx = 0
idx2 = 0
for (mvids in find610_gt4$movieId)
{
  idx = idx + 1
  for (mvs610 in find_mvs2)
  {
    
      if (mvs610 == mvids){
        idx2 = idx2 + 1
        cat(movies$title[idx],"-" , find_rt[idx2,1],"\n")
      }
    
  }
  
}



# saveRDS(movies, file="./data/movie_data.rds")
# saveRDS(ratings, file="./data/ratings_data.rds")
```
## 1.2. ë¬´ë¹„ë Œì¦ˆ ë°ì´í„° ì „ì²˜ë¦¬
  ìºê¸€ì—ì„œ ë¬´ë¹„ë Œì¦ˆ ë°ì´í„°("movies", "ratings", "tags") csv íŒŒì¼ì„ ìˆ˜ì§‘í•œ í›„ ì‚¬ìš©ì í‰ì ë°ì´í„°, ì˜í™”ë°ì´í„°, íƒœê·¸ë°ì´í„°ë¥¼ ì‚´í´ë³´ê³  ì ì ˆí•œ ì „ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•˜ì˜€ë‹¤.
```{r ì „ì²˜ë¦¬}
setwd("C:\\r_suzin\\PRJ")
#ë°ì´í„° í¬ê¸° í™•ì¸ -------------------
datafiles <- c("movies", "ratings", "tags")
suf <- ".csv"

for (f in datafiles) {
    path <- file.path("./data/", paste0(f, suf))
    assign(f, read_csv(path, col_types = cols()))
    print(paste(f, "íŒŒì¼í¬ê¸°:", format(object.size(get(f)), units="Mb")))
}

#ë°ì´í„° ì „ì²˜ë¦¬ -------------------------------
##ì‚¬ìš©ì í‰ì  ë°ì´í„°
df_ratings <- ratings %>%
    mutate(timestamp = as_datetime(timestamp))

glimpse(df_ratings)
skim(df_ratings)

##ì˜í™” ë°ì´í„°
df_movies <- movies %>%
    mutate(title = str_trim(title)) %>%
    extract(title, c("title_tmp", "year"), regex = "^(.*) \\(([0-9 \\-]*)\\)$", remove = FALSE) %>%
    mutate(year = ifelse(str_length(year) > 4, as.integer(str_split(year, "-", simplify = TRUE)[1]), as.integer(year))) %>%
    mutate(title = ifelse(is.na(title_tmp), title, title_tmp)) %>%
    select(-title_tmp)  %>%
    mutate(genres = ifelse(genres == "(no genres listed)", `is.na<-`(genres), genres))

glimpse(df_movies)
skim(df_movies)

##íƒœê·¸ ë°ì´í„°
df_tags <- tags %>%
    mutate(timestamp = as_datetime(timestamp))

glimpse(df_tags)
skim(df_tags)
```
## 1.3. íƒìƒ‰ì  ë°ì´í„° ë¶„ì„
  ì˜í™” ì¶”ì²œì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œ ê° ë°ì´í„°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆëŠ” ì •ë³´ê°€ ë¬´ì—‡ì´ ìˆì„ê¹Œ?
  
  - ì‚¬ìš©ì í‰ì ì„ ê¸°ë°˜í•˜ì—¬ ì—°ë„ë³„ ê°€ì¥ ì¸ê¸° ìˆëŠ” ì˜í™”ëŠ” ë­ì˜€ì„ê¹Œ?
  - ì‚¬ìš©ì í‰ì ì„ ê¸°ë°˜í•˜ì—¬ ì¥ë¥´ë³„ ê°€ì¥ ì¸ê¸° ìˆëŠ” ì˜í™”ëŠ” ë­ì˜€ì„ê¹Œ?
  - ì–´ë–¤ ì¥ë¥´ì˜ ì˜í™”ê°€ ë§ì„ê¹Œ?
  - ì—°ë„ë³„ ì˜í™”ê°€ ëª‡í¸ì´ë‚˜ ê°œë´‰ë˜ì—ˆì„ê¹Œ?
  - íƒœê·¸ëŠ” ê° ì˜í™”ì— ì–´ë–¤ íŠ¹ì„±ì„ ë‚˜íƒ€ë‚´ê³  ìˆì„ê¹Œ? íƒœê·¸ ë‚´ìš©ì„ í™•ì¸í•´ë³´ì.
  
```{r í‰ì íƒìƒ‰}
#íƒìƒ‰ì  ë°ì´í„° ë¶„ì„ 
## í‰ì  ê¸°ë°˜ ì—°ë„ë³„ ì¸ê¸° ì˜í™” --------------------------
avg_rating <- df_ratings %>%
    inner_join(df_movies, by = "movieId") %>%
    na.omit() %>%
    select(movieId, title, rating, year) %>%
    group_by(movieId, title, year) %>%
    summarise(count = n(), mean = mean(rating), min = min(rating), max = max(rating)) %>%
    ungroup() %>%
    arrange(desc(mean))

weighted_rating <- function(R, v, m, C) {
    return (v/(v+m))*R + (m/(v+m))*C
}
# R = average for the movie (mean) = (Rating)
# v = number of votes for the movie = (votes)
# m = minimum votes required to be listed in the Top 250
# C = the mean vote across the whole report
```
í‰ì ìœ¼ë¡œ ì¸ê¸° ì˜í™”ë¥¼ ì•Œì•„ë³¼ ë•Œ TMDB Ratingsì„ ì‚¬ìš©í•˜ì˜€ê³  IMDBì˜ weighted rating ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬ í‰ì ì— ê°€ì¤‘ì¹˜ë¥¼ ì£¼ì—ˆë‹¤. ì•„ë˜ í‘œì—ì„œ weighted rating(wr)ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```{r í‰ì íƒìƒ‰2}
avg_rating <- avg_rating %>%
    mutate(wr = weighted_rating(mean, count, 500, mean(mean))) %>%
    arrange(desc(wr))

avg_rating %>%
    mutate(decade = year  %/% 10 * 10) %>%
    arrange(year, desc(wr)) %>%
    group_by(decade) %>%
    summarise(title = first(title), wr = first(wr), mean = first(mean), count = first(count)) %>% 
    DT::datatable() %>% 
    DT::formatRound("count", digits = 0, interval = 3)


## ê°€ì¤‘ì¹˜ í‰ê·  ë¶„í¬ í™•ì¸
hist(avg_rating$wr)
hist(scale(avg_rating$wr))
hist(log(avg_rating$wr))
hist(scale(log(avg_rating$wr)))
wr2 <- scale(log(avg_rating$wr))
wr2 <- log(avg_rating$wr)

y <- quantile(wr2, c(0.25, 0.75)) 
x <- qnorm( c(0.25, 0.75))
slope <- diff(y) / diff(x) 
int <- y[1] - slope * x[1]
ggplot(avg_rating) + 
  stat_qq(aes(sample=log(wr))) +
  geom_abline(intercept=int, slope=slope, color="steelblue3") + 
  labs(title="ê°€ì¤‘ì¹˜ í‰ê· í‰ì  Q-Q plot")


## í‰ì  ê¸°ë°˜ ì¥ë¥´ë³„ ì¸ê¸° ì˜í™” --------------------------
genres_rating <- df_movies %>%
    na.omit() %>%
    select(movieId, year, genres) %>%
    inner_join(df_ratings, by = "movieId") %>%
    select(-timestamp, -userId) %>%
    mutate(decade = year  %/% 10 * 10) %>%
    separate_rows(genres, sep = "\\|") %>%
    group_by(year, genres) %>%
    summarise(count = n(), avg_rating = mean(rating)) %>%
    ungroup() %>%
    mutate(wr = weighted_rating(mean, count, 500, mean(mean))) %>%
    arrange(year)

genres_rating %>%
    filter(genres %in% c("Drama", "Comedy", "Horror", "Thriller")) %>%
    ggplot(aes(x = year, y = wr)) +
    geom_line(aes(group=genres, color=genres)) +
    geom_smooth(aes(group=genres, color=genres)) +
    facet_wrap(~genres)
```

```{r ì—°ë„ë³„ì˜í™”íƒìƒ‰}
##ì—°ë„ë³„ ì˜í™” ë¶„ì„ ---------------------------
movies_per_year <- df_movies %>%
    na.omit() %>%
    select(movieId, year) %>%
    group_by(year) %>%
    summarise(count = n())  %>%
    arrange(year)

#y=ì—°ë„ë³„ ì¶œì‹œ ì˜í™”ë¹ˆë„ìˆ˜, x=ì—°ë„
movies_per_year %>%
    complete(year = full_seq(year, 1), fill = list(count = 0)) %>% 
    #filter(year <=2015) %>% 
    ggplot(aes(x = year, y = count)) +
    geom_line(color="steelblue3", size=1.5) +
    scale_y_continuous(labels=scales::comma) +
    labs(x="year", y="freq.") + theme_tufte()
```
1902ë…„ë¶€í„° 2018ë…„ê¹Œì§€ì˜ ì˜í™”ë°ì´í„°ì´ë‹¤. ë§¤ë…„ ì¦ê°€í•¨ì— ë”°ë¼ ë§¤ë…„ ì˜í™”ì˜ ìˆ˜ê°€ ì¦ê°€í•˜ê³  ìˆê³  1975ë…„ ì´í›„ë¡œ ì˜í™” ê°œë´‰ ë¹ˆë„ìˆ˜ê°€ ê¸‰ê²©í•˜ê²Œ ì¦ê°€í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. 2000ë…„ëŒ€ì— ì§„ì…í•˜ë©´ì„œ ì˜í™” ê°œë´‰ ìˆ˜ê°€ ê°€ì¥ ë§ì•˜ê³  2015ë…„ ì´í›„ë¡œ ê¸‰ê²©íˆ ì¤„ì—ˆë‹¤. ë°ì´í„°ë¥¼ ë¯¸ìˆ˜ì§‘í–ˆì„ ê°€ëŠ¥ì„±ë„ ìˆì„ ê²ƒ ê°™ë‹¤.
```{r ì—°ë„ë³„ì¥ë¥´íƒìƒ‰}
##ì—°ë„ë³„ ì¥ë¥´ ë¶„ì„ ---------------------------
df_movies %>%
    separate_rows(genres, sep = "\\|") %>% 
    count(genres) %>% 
    arrange(desc(n)) %>% 
    mutate(ë¹„ìœ¨ = scales::percent(n/sum(n, na.rm=TRUE)),
             ëˆ„ì ë¹„ìœ¨ = scales::percent(cumsum(n/sum(n, na.rm=TRUE)))) %>% 
    select(ì˜í™”ì¥ë¥´=genres, ì¥ë¥´ë¹ˆë„ìˆ˜=n, ì¥ë¥´ë¹„ìœ¨=ë¹„ìœ¨, ëˆ„ì ë¹„ìœ¨) %>% 
    DT::datatable() %>% 
    DT::formatRound("ì¥ë¥´ë¹ˆë„ìˆ˜", interval=3, digits=0)

##ì—°ë„ë³„ ì˜í™” ê°œë´‰ ìˆ˜ y=ì—°ë„ë³„ ì¶œì‹œ ì˜í™”ë¹ˆë„ìˆ˜, x=ì—°ë„
df_movies %>%
    separate_rows(genres, sep = "\\|") %>%
    na.omit() %>% 
    mutate(genres = as.factor(genres)) %>% 
    group_by(year, genres) %>%
    summarise(number = n()) %>%
    complete(year = full_seq(year, 1), genres, fill = list(number = 0)) %>% 
    filter(genres %in% c("Drama", "Comedy", "Thriller", "Action", "Romance", "Sci-Fi", "Horror")) %>%
    filter(year >= 1900 & year <= 2015) %>% 
    ggplot(aes(x = year, y = number)) +
    geom_line(aes(color=genres), size=1) +
    scale_fill_brewer(palette = "Paired") +
    labs(x="year", y="freq.", color="ì¥ë¥´") + 
    theme_tufte() + theme(legend.position = "top")
```
ì˜í™”ì¥ë¥´ë³„ ì¥ë¥´ë¹ˆë„ìˆ˜ë¥¼ í™•ì¸í•´ë³¸ ê²°ê³¼ Drama, Comedy, Thriller, Action, Romance ìˆœìœ¼ë¡œ ë§ì•˜ë‹¤. íŠ¹íˆ Dramaì™€ ComedyëŠ” ê°ê° ë¹„ìœ¨ì´ 19.74%, 17%ì´ê³  ë‘ ì¥ë¥´ì˜ ëˆ„ì  ë¹„ìœ¨ì´ 45%ì— ë‹¬í•˜ì—¬ ìƒëŒ€ì ìœ¼ë¡œ ë‹¤ë¥¸ ì¥ë¥´ì— ë¹„í•´ ë§ì€ ë¹„ìœ¨ì„ ì°¨ì§€í•˜ê³  ìˆë‹¤. ì´ë¥¼ í†µí•´ ì‚¬ëŒë“¤ì˜ ì˜í™” ì¥ë¥´ ì„ í˜¸ë„ë¥¼ ì˜ˆìƒí•´ë³¼ ìˆ˜ ìˆì—ˆê³  ì¶”ì²œ ì¥ë¥´ë¡œ Dramaì™€ Comedyê°€ ìì£¼ ë“±ì¥í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒí•´ ë³¼ ìˆ˜ ìˆê² ë‹¤.
```{r ì¥ë¥´ë³„íƒœê·¸íƒìƒ‰}
##ì¥ë¥´ë³„ íƒœê·¸ ë¶„ì„ ---------------------------
genres_tags <- df_movies %>%
    na.omit() %>%
    select(movieId, year, genres) %>%
    separate_rows(genres, sep = "\\|") %>%
    inner_join(df_tags, by = "movieId") %>%
    select(genres, tag) %>%
    group_by(genres) %>%
    nest()

# Drama, Comedy, Thriller, Action, Romance, Sci-Fi == 7 4 9 15 6 12
stock = genres_tags$genres
genre<-stock[6]
genre_words <- genres_tags %>%
    filter(genres == genre) %>%
    unnest() %>%
    mutate(tag = str_to_lower(tag, "en")) %>%
    anti_join(tibble(tag=c(tolower(genre)))) %>%
    count(tag)

wordcloud(genre_words$tag, genre_words$n, max.words = 50, colors=brewer.pal(8, "Paired"))
```
ì¥ë¥´ë¹ˆë„ìˆ˜ê°€ ê°€ì¥ ë§ì•˜ë˜ ì¥ë¥´ ìœ„ì£¼ë¡œ íƒœê·¸ ë‚´ìš©ì„ ì›Œë“œí´ë¼ìš°ë“œë¥¼ í†µí•´ ëŒ€ëµì ìœ¼ë¡œ  í™•ì¸í•´ë³´ì•˜ë‹¤.
```{r íƒœê·¸íƒìƒ‰, eval=FALSE}
#íƒœê·¸ ëª©ë¡ì— ë‚˜íƒ€ë‚˜ëŠ” íšŸìˆ˜ê³„ì‚°
df1 = genres_tags$data[[1]]
df2 = genres_tags$data[[2]]
#anti_join(df1,df2) # df1ì—ëŠ” ìˆê³  df2ì—ëŠ” ì—†ëŠ” tagë¥¼ ì¶œë ¥í•´ì¤Œ
df3 = genres_tags$data[[3]]
df4 = genres_tags$data[[4]]
df5 = genres_tags$data[[5]]
df6 = genres_tags$data[[6]]
df7 = genres_tags$data[[7]]
df8 = genres_tags$data[[8]]
df9 = genres_tags$data[[9]]
df10 = genres_tags$data[[10]]
df11 = genres_tags$data[[11]]
df12 = genres_tags$data[[12]]
df13 = genres_tags$data[[13]]
df14 = genres_tags$data[[14]]
df15 = genres_tags$data[[15]]
df16 = genres_tags$data[[16]]
df17 = genres_tags$data[[17]]
df18 = genres_tags$data[[18]]
df19 = genres_tags$data[[19]]

df1_tag = df1[which(duplicated(df1)|duplicated(df1,fromLast=T)),]
df2_tag = df2[which(duplicated(df2)|duplicated(df2,fromLast=T)),]
df3_tag = df3[which(duplicated(df3)|duplicated(df3,fromLast=T)),]
df4_tag = df4[which(duplicated(df4)|duplicated(df4,fromLast=T)),]
df5_tag = df5[which(duplicated(df5)|duplicated(df5,fromLast=T)),]

df6_tag = df6[which(duplicated(df6)|duplicated(df6,fromLast=T)),]
df7_tag = df7[which(duplicated(df7)|duplicated(df7,fromLast=T)),]
df8_tag = df8[which(duplicated(df8)|duplicated(df8,fromLast=T)),]
df9_tag = df9[which(duplicated(df9)|duplicated(df9,fromLast=T)),]
df10_tag = df10[which(duplicated(df10)|duplicated(df10,fromLast=T)),]

df11_tag = df11[which(duplicated(df11)|duplicated(df11,fromLast=T)),]
df12_tag = df12[which(duplicated(df12)|duplicated(df12,fromLast=T)),]
df13_tag = df13[which(duplicated(df13)|duplicated(df13,fromLast=T)),]
df14_tag = df14[which(duplicated(df14)|duplicated(df14,fromLast=T)),]
df15_tag = df15[which(duplicated(df15)|duplicated(df15,fromLast=T)),]

df16_tag = df16[which(duplicated(df16)|duplicated(df16,fromLast=T)),]
df17_tag = df17[which(duplicated(df17)|duplicated(df17,fromLast=T)),]
df18_tag = df18[which(duplicated(df18)|duplicated(df18,fromLast=T)),]
df19_tag = df19[which(duplicated(df19)|duplicated(df19,fromLast=T)),]

barplot(table(df1_tag))
barplot(table(df2_tag))
barplot(table(df3_tag))
barplot(table(df4_tag))
barplot(table(df5_tag))
barplot(table(df19_tag))
```

</br></br>

---

</br></br>

# 2. ì˜í™” ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜

```  
ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì—ëŠ” ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆë‹¤.
  
  1. Simple Recommender : ì´ ì ‘ê·¼ ë°©ì‹ì€ íŠ¹ì • ê¸°ì¤€ì— ë”°ë¼ ëª¨ë“  ì˜í™”ì˜ ìˆœìœ„ë¥¼ ë§¤ê¸´ ë‹¤ìŒ ê°œë³„ ì„ í˜¸ë„ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê³  ì‚¬ìš©ìì—ê²Œ ìµœê³ ì˜ ì˜í™”ë¥¼ ì œì•ˆí•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ Netflixì˜ 'ì˜¤ëŠ˜ ë¯¸êµ­ ë‚´ ìƒìœ„ 10 ìœ„'ê°€ ë  ìˆ˜ ìˆë‹¤.

  2. í˜‘ì—… í•„í„°ë§ : ì´ ì ‘ê·¼ ë°©ì‹ì€ ì‚¬ìš©ìì˜ ê³¼ê±° í–‰ë™ì„ í™œìš©í•˜ì—¬ ì‚¬ìš©ìê°€ ê´€ì‹¬ì„ ê°€ì§ˆë§Œí•œ í•­ëª©ì„ ì˜ˆì¸¡í•œë‹¤. ì‚¬ìš©ìê°€ ì´ì „ì— ë³¸ ì˜í™”, í•´ë‹¹ í•­ëª©ì— ë¶€ì—¬ ëœ ìˆ«ì ë“±ê¸‰ ë° ìœ ì‚¬í•œ ì‚¬ìš©ìê°€ ì´ì „ì— ë³¸ ì˜í™”ë¥¼ ê³ ë ¤í•œë‹¤.

  3. ì½˜í…ì¸  ê¸°ë°˜ í•„í„°ë§ : ì´ ì ‘ê·¼ ë°©ì‹ì€ íŠ¹ì • í•­ëª©ì˜ ì†ì„±ê³¼ ë©”íƒ€ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ìœ ì‚¬í•œ íŠ¹ì„±ì„ ê°€ì§„ ë‹¤ë¥¸ í•­ëª©ì„ ì œì•ˆí•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì¶”ì²œìëŠ” ì˜í™”ì˜ ì¥ë¥´ì™€ ê°ë…ì„ ë¶„ì„í•˜ì—¬ ìœ ì‚¬í•œ ì†ì„±ì„ ê°€ì§„ ì¶”ê°€ ì˜í™”ë¥¼ ì¶”ì²œ í•  ìˆ˜ ìˆë‹¤.
```

## 2.0. êµ°ì§‘í™”ë¶„ì„
  ì¥ë¥´, íƒœê·¸ ë‚´ìš© ëª¨ì•„ì„œ table
```{r}
setwd("C:\\r_suzin\\PRJ")
# êµ°ì§‘ë¶„ì„ code
user_genres2 <- read.csv("./data/user_genres.csv", header=T)
View(user_genres2)
ug <- user_genres2 %>% 
  group_by(userId, genres) %>%
  summarise(mean_rating=mean(rating))
ug2 <- xtabs(mean_rating ~ userId + genres, ug)
df_ug <- as.data.frame.matrix(ug2)[unique(user_genres2$userId), ]

# clustering
result <- hclust(dist(df_ug),method="average") # í‰ê· ê±°ë¦¬ê°’ì„ ì´ìš©í•œ ê³„ì¸µì  êµ°ì§‘í™”
plot(result,hang=-1) # ìœ„ ì‹œê°í™”

result2 <- kmeans(df_ug,6)
names(result2)

g1<-subset(df_ug, result2$cluster==1)
g2<-subset(df_ug, result2$cluster==2)
g3<-subset(df_ug, result2$cluster==3)
g4<-subset(df_ug, result2$cluster==4)
g5<-subset(df_ug, result2$cluster==5)
g6<-subset(df_ug, result2$cluster==6)

summary(g1)
summary(g2)

#ë¹„ê³„ì¸µì ëª¨ë¸
df_ug$cluster<-result2$cluster
head(df_ug)
cor(df_ug[,-21], method="pearson")

#ì ì˜í•œ êµ°ì§‘kì°¾ê¸°
df_ug.out.withness<-c()
df_ug.out.between<-c()
for (i in 2:10){ 
 set.seed(1)
 df_ug.out<-kmeans(df_ug[,-21], centers=i)
 df_ug.out.withness[i-1]<-df_ug.out$tot.withinss #êµ°ì§‘ ë‚´ ì œê³±í•©ì˜ í•©
 df_ug.out.between[i-1]<-df_ug.out$betweenss #êµ°ì§‘ ê°„ ì œê³±í•©ì˜ í•©
}
data.frame(df_ug.out.withness, df_ug.out.between) 
visual <- NULL
for(i in 2:10){
 
  set.seed(0723)
  eval(parse(text=paste("result",i,"<- kmeans(df_ug[,-21],",i,");",sep="")))
  eval(parse(text=paste("visual[",i,"] <- result",i,"$tot.withinss",sep="")))
}

plot(visual[-1], type="l", ylab="", xlab="", main="clusterì˜ ê°œìˆ˜ì— ë”°ë¥¸ ë‚´ë¶€ë¶„ì‚°")
abline(v=6,col="red")
abline(v=8,col="red") # ê²½ì‚¬ê°€ ê¸‰ê²©í•˜ê²Œ ì¤„ì–´ë“¤ë‹¤ê°€ ì™„ë§Œí•´ì§€ëŠ” 6~ê°œì˜ êµ°ì§‘ìœ¼ë¡œ ë¶„ë¥˜í•˜ëŠ”ê²Œ ì¢‹ë‹¤?

table(df_ug$cluster)
pie(table(df_ug$cluster))
```

## 2.1. í˜‘ì—…í•„í„°ë§(í‰ì , ì¥ë¥´)
  1. ìœ ì €ê¸°ë°˜(UBCF)
    - í•´ë‹¹ ìœ ì €ì™€ ì·¨í–¥ì´ ë¹„ìŠ·í•œ ìœ ì €ê°€ ì¢‹ê²Œ í‰ê°€í•œ ê²ƒì„ ì¶”ì²œ
    - ë” ì •êµí•¨
    - ìœ ì €ê°€ ì‹ ê·œ ì§„ì…í• ë•Œë§ˆë‹¤ ê³„ì‚°í•´ì•¼ í•´ì„œ êµ¬í˜„ì— ì‹œê°„ì´ ë” ê±¸ë¦¼
    
  2. ìƒí’ˆê¸°ë°˜(IBCF)
    - ìƒí’ˆê°„ ìœ ì‚¬ë„ ë°”íƒ•
    - ë¯¸ë¦¬ ê³„ì‚°í•´ ë†“ê¸° ë•Œë¬¸ì— ì‹ ê·œ ì§„ì…í• ë•Œë§ˆë‹¤ ê³„ì‚°í•  í•„ìš”ê°€ ì—†ìŒ
    
  3. ì¶”ì²œì‹œìŠ¤í…œ í‰ê°€ì§€í‘œ
    - ROCê³¡ì„ 
    - ì •í™•ë„:  ì‚¬ìš©ìê°€ ì‹¤ì œ ì„ íƒí•œ ì•„ì´í…œ ìˆ˜ / ì „ì²´ ì¸¡ì •ëœ ì•„ì´í…œ ìˆ˜
    - ì¬í˜„ìœ¨: ë§ëŠ” ì¶”ì²œ ì•„ì´í…œ ìˆ˜ / ì‚¬ìš©ìê°€ ì„ íƒí•œ ì „ì²´ ì•„ì´í…œ ìˆ˜

```{r 2.1 í‰ì ë°ì´í„°ì¤€ë¹„, eval=FALSE}
#ë¶„ì„ë°ì´í„°ì¤€ë¹„ ------------------------
#ë¬´ë¹„id ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ í›„ ìƒˆ ì¸ë±ìŠ¤ ë¶€ì—¬
m <- m[order(m$movieId),]
m$idx <- 1:nrow(m)

#movies-rating ë³‘í•©: mr
mr <- merge(m, r, key='movieId', all.y=T)
mr <- mr[,-c(1,7)]
mr <- mr[,-c(2,3)]

sum(duplicated(mr)) #[1] 3
which(duplicated(mr)|duplicated(mr,fromLast=T))
mr[which(duplicated(mr)|duplicated(mr,fromLast=T)),]
mr <- mr[-which(duplicated(mr)|duplicated(mr,fromLast=T)),]
mr <- mr[-c(80209,88669),]

View(mr)

#write.csv(mr, "./data/mr.csv",row.names = F)
```
```{r 2.1 í‰ì CF split}

#ë°ì´í„°í˜•ì„ realRatingMatrixë¡œ ë³€í™˜ -------------------------------
setwd("C:\\r_suzin\\PRJ\\")


c_movies <- unique(df_movies$movieId)
r_users <- unique(df_ratings$userId)
View(r_users)

# MAT 610 x 9742 for IBCF
mat_moviesId_usersId <- matrix(0,length(r_users),length(c_movies))


colnames(mat_moviesId_usersId) <- df_movies$movieId[unique(df_movies$movieId)]
rownames(mat_movies_users) <- df_ratings$userId[unique(df_movies$userId)]
View(mat_moviesId_usersId)

for (rows in 1:nrow(mat_moviesId_usersId)){
  for(cols in 1:ncol(mat_moviesId_usersId)){
    #movieIdê°€ ê°™ì€ ê²½ìš°
    col_users = which(mat_movies_users[1,] == df_ratings[rows, 2])
    mat_moviesId_usersId[rows+1, col_users] <- df_ratings$rating[rows]
  }
}

View(mat_moviesId_usersId)


ratingMatrix <- dcast(df_ratings, userId~movieId, value.var = "rating", na.rm = FALSE)
ratingMatrix <- as.matrix(ratingMatrix[,-1]) # remove userID
View(ratingMatrix)

ratingMatrix <- as(ratingMatrix, "realRatingMatrix")

mat_similarity <- similarity(ratingMatrix[1:4, ], method = "pearson", which = "items")
as.matrix(mat_similarity)
image(as.matrix(mat_similarity), main = "item's similarity")


# mr <- read.csv("./data/mr.csv", header=T)
# mr <- mr[,c(2,1,3)]
# View(mr)
# user_mr <- as(mr, "realRatingMatrix")
# View(user_mr)
# image(user_mr[1:100, 1:100], main = "Real rating matrix") #sparse

#ë¨¸ì‹ ëŸ¬ë‹ì„ ìœ„í•´ í•™ìŠµë°ì´í„°ì„ ì • -----------------------------------
set.seed(2021)
index <- sample(1:nrow(ratingMatrix), size = nrow(ratingMatrix)*0.8)
train <- ratingMatrix[index, ]
#test setì€ ì¶”ì²œ ë°›ì„ ì‚¬ìš©ìë¦¬ìŠ¤íŠ¸ê°€ ë ê±°ì„
recommenderUserList  <- ratingMatrix[-index,]

#í–‰ì˜ ì´í•© 25ê°œ ì´ìƒì˜ ì•„ì´í…œ(ì˜í™”)ë§Œ ì„ íƒ ------------------------
#ì•„ì´í…œì´ ì ì€ ê²ƒì€ ì™œê³¡ëœ ì¶”ì²œê²°ê³¼ë¥¼ ë³´ë‚´ì¤„ ìˆ˜ ìˆìŒ
train2 <- train[rowCounts(train)>25]
check = as(train2, "matrix") #429*9719
#evaluationScheme() -----------------------------------------------
#ì¶”ì²œ í‰ê°€ ë°©ì‹
#splitë¶„í• , cross-validationêµì°¨ê²€ì •(ì „ì²´ ë°ì´í„°ì…‹ì„ kê°œë¡œ ë‚˜ëˆˆë‹¤)
#k ì‹œë®¬ë ˆì´ì…˜ ë°˜ë³µíšŸìˆ˜
#given ì‚¬ëŒë‹¹ í‰ê°€í•˜ëŠ” ì•„ì´í…œ ìˆ˜
#goodrating ì‹¤ì œ ì‚¬ìš© ë“±ê¸‰ì´ 3ì´ìƒì´ë©´ ëª¨ë‘ í‰ê°€ì— í¬í•¨
#ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ê²°ê³¼ê°€ ë°”ë€œ
#ë„ˆë¬´ë§ì´ ëŒë ¤ë„ ê°œì„ ì— ì¢‹ì€ ê²ƒì€ ì•„ë‹ˆê³  ì ê²Œ ëŒë ¤ë„ í¸ì°¨ê°€ê°€ í¬ë‹¤. ì ë‹¹í•œ k 
eval_sets <- evaluationScheme(data = train2, 
                              method = "split",
                              train = .8, 
                              given = 6,
                              goodRating = 3.5, 
                              k = 3)
##ì¶”ì²œëª¨ë¸ìƒì„± -----------------------------------------------------
#Recommender() ì¶”ì²œì‹œë®¬ë ˆì´ì…˜
#data: train datasetìœ¼ë¡œ ì„¤ì •ëœ ë°ì´í„°í”„ë ˆì„
#method: ì‚¬ìš©í•  ì¶”ì²œë°©ë²•ì •ì˜
#parameter: ì¶”ì²œì•Œê³ ë¦¬ì¦˜ì˜ íŒŒë¼ë¯¸í„°(cosine/pearson)
mr_UBCF <- Recommender(train2, 
                      method = "UBCF",
                      parameter="Cosine")
mr_UBCF

mr_IBCF <- Recommender(train2, 
                      method = "IBCF",
                      parameter="Cosine") # ì‹œê°„ì†Œìš”
mr_IBCF
##ì¶”ì²œëª¨ë¸í‰ê°€ -----------------------------------------------------
#ì¶”ì²œ
UBCFlist <- predict(mr_UBCF, recommenderUserList, n=5)
IBCFlist <- predict(mr_IBCF, recommenderUserList, n=5)
#ì¶”ì²œ ë°›ì€ ë¦¬ìŠ¤íŠ¸
head(as(UBCFlist, "list"),2) # 18ë²ˆ ìœ ì €ì—ê²Œ ë‹¤ìŒ 5ê°œ ì˜í™”ë¥¼ ì¶”ì²œ
head(as(IBCFlist, "list"),2) # 18ë²ˆ ìœ ì €ì—ê²Œ ë‹¤ìŒ 5ê°œ ì˜í™”ë¥¼ ì¶”ì²œ

IBCFlist@items

View(IBCFlist)

#ì‚¬ì‹¤ìƒ ì¶”ì²œê³¼ì • ë. ëª¨ë¸ ê²°ê³¼í‘œì™€ ê·¸ë˜í”„ë¥¼ ìƒì„±-------------------
#ì‹œë®¬ë ˆì´ì…˜ì— ì‚¬ìš©í•  ì•Œê³ ë¦¬ì¦˜ê³¼ ìœ ì‚¬ë„ ì§€í‘œ ì¢…ë¥˜ ì§€ì •--------------

mr_al_UBCF <- list("user-based CF_Cosine" = list(name="UBCF",
                                                 parameter=
                                                   list(method="Cosine")),
                   "user-based CF_Pearson" = list(name="UBCF",
                                                 parameter=
                                                   list(method="Pearson")))

mr_al_IBCF <- list("item-based CF_Cosine" = list(name="IBCF",
                                                 parameter=
                                                   list(method="Cosine")),
                   "item-based CF_Pearson" = list(name="IBCF",
                                                 parameter=
                                                   list(method="Pearson")))
#evaluate() -------------------------------------------------------
#evaluationSchemeì„ í†µí•´ ì£¼ì–´ì§„ ì¶”ì²œ ëª¨ë¸ì˜ ëª©ë¡ì„ í‰ê°€
#algorithms ì‚¬ìš©í•  ì•Œê³ ë¦¬ì¦˜(ì‹œë®¬ë ˆì´ì…˜) ì§€ì •
#n: ì¶”ì²œë°›ì„ê°ì²´ìˆ˜(ubcf - ì‚¬ëŒ, ifcf - ì•„ì´í…œ)
# result1 <- evaluate(eval_sets, mr_al_UBCF, n=c(1,3,5))
# result1
# avg(result1)
# ì˜¤ë¥˜í•´ê²°x
result2 <- evaluate(eval_sets, mr_al_IBCF, n=c(1,3,5))
result2
names(result2)
avg(result2)
#í•µì‹¬ì ìœ¼ë¡œ ë³¼ ê²ƒì€ precisionê³¼ recall, ì§ê´€ì ìœ¼ë¡œ ê·¸ë˜í”„ë¥¼ í†µí•´ ë³´ì.
plot(result2, annotate=T, legend="topleft") #ROC) IBCF ê²½ìš° ì½”ì‚¬ì¸ë°©ì‹ì´ ë” ì„±ëŠ¥ì´ ì¢‹ë‹¤.
plot(result2, annotate=T, "prec/rec", legend="bottomright") #pre/rec)
#ê·¸ë˜í”„ë¥¼ ë³´ê³  ubcf, ibcf ì¶”ì²œì„±ëŠ¥ ë¹„êµ
#ë§¤ê°œë³€ìˆ˜íŠœë‹ ìœ„ ë°˜ë³µ
```
```{r 2.1 í‰ì CF cross-validation}
eval_sets2 <- evaluationScheme(data = train2, 
                              method = "cross-validation",
                              train = .8, 
                              given = 6,
                              goodRating = 3.5, 
                              k = 3)
##ì¶”ì²œëª¨ë¸ìƒì„± -----------------------------------------------------
mr_UBCF2 <- Recommender(train2, 
                      method = "UBCF",
                      parameter="Cosine")
mr_UBCF2

mr_IBCF2 <- Recommender(train2, 
                      method = "IBCF",
                      parameter="Cosine") # ì‹œê°„ì†Œìš”
mr_IBCF2
##ì¶”ì²œëª¨ë¸í‰ê°€ -----------------------------------------------------
#ì¶”ì²œ
UBCFlist2 <- predict(mr_UBCF2, recommenderUserList, n=5)
IBCFlist2 <- predict(mr_IBCF2, recommenderUserList, n=5)
#ì¶”ì²œ ë°›ì€ ë¦¬ìŠ¤íŠ¸
head(as(UBCFlist2, "list"),2) 
head(as(IBCFlist2, "list"),2)

mr_al_UBCF <- list("user-based CF_Cosine" = list(name="UBCF",
                                                 parameter=
                                                   list(method="Cosine")),
                   "user-based CF_Pearson" = list(name="UBCF",
                                                 parameter=
                                                   list(method="Pearson")))

mr_al_IBCF <- list("item-based CF_Cosine" = list(name="IBCF",
                                                 parameter=
                                                   list(method="Cosine")),
                   "item-based CF_Pearson" = list(name="IBCF",
                                                 parameter=
                                                   list(method="Pearson")))
algorithms
#evaluate() -------------------------------------------------------
result_uu <- evaluate(eval_sets2, mr_al_UBCF, n=c(1,3,5))
result_uu
avg(result_uu)
# ì˜¤ë¥˜í•´ê²°x

#####################################################################
#####################################################################
result_ui <- evaluate(eval_sets2, mr_al_IBCF, n=c(1,3,5))
names(result_ui)
avg(result_ui)
saveRDS(result_ui, "./data/result_ui.rds") # í‰ì  ì•Œê³ ë¦¬ì¦˜=mr_al_IBCF

result_al <- evaluate(eval_sets2, algorithms, n=c(1,3,5))
names(result_al)
avg(result_al)
saveRDS(result_al, "./data/result_al.rds") # í‰ì  ì•Œê³ ë¦¬ì¦˜=algorithms
##################################################################### í‰ì  ìµœì¢… ë¹„êµê²°ì •
plot(result_ui, annotate=T, legend="topleft") # ifcf cosine > pearson
plot(result_ui, annotate=T, "prec/rec", legend="bottomright") # ifcf cosine > pearson
plot(result_al, annotate=T, legend="topleft")
plot(result_al, annotate=T, "prec/rec", legend="bottomright")

##################################################################### í‰ì  ìˆ˜ì¹˜ë‹ˆê¹Œ rmse
```

# í‰ì  ìµœì¢…
```{r í‰ì  ìµœì¢…}
#####################################################################
## SVD_ P
rating_final_eval <- evaluationScheme(data = df,
                              method = "cross-validation",
                              train = 0.8,
                              k = 3,
                              goodRating = 3,
                              given = 20)

# Training dataset modeling ------------------------ (1)
rating_SVD_P <- Recommender(data = getData(rating_final_eval, "train"),
                           method = "SVD", 
                           parameter = "Pearson")
rating_SVD_P

#######################íŠ¹ì •ìœ ì €ì— ëŒ€í•œ ìµœì¢…ì˜ˆì¸¡ì˜í™”ë¦¬ìŠ¤íŠ¸
# Prediction
rating_SVD_P_list <- predict(rating_SVD_P, 
                     newdata = getData(rating_final_eval, "known"),
                     n = 10, type = "topNList")
rating_SVD_P_list@items$`610`
##############################################

rating_SVD_P_pred <- predict(rating_SVD_P, 
                     newdata = getData(rating_final_eval, "known"),
                     n = 10, type = "ratings")

# Calculate accuracy
rating_SVD_P_pred_acc <- calcPredictionAccuracy(x = rating_SVD_P_pred,
                                        data = getData(rating_final_eval, "unknown"),
                                        byUser = TRUE) # byUser = TRUE : ê° ì‚¬ìš©ìë“¤ì— ëŒ€í•œ ëª¨ë¸ì˜ ì •í™•ë„ê°€ ê³„ì‚°
#head(accuracy_eval, 10)
colMeans(rating_SVD_P_pred_acc, na.rm=T) #ì •í™•ë„ #################################### ìµœì¢… rmse

rating_SVD_P_pred_acc2 <- evaluate(x = rating_final_eval, 
                           method = "SVD",
                           parameter = "Pearson")
head(getConfusionMatrix(rating_SVD_P_pred_acc2))

plot(rating_SVD_P_pred_acc)
plot(rating_SVD_P_pred_acc2, annotate=T, legend="topleft")
plot(rating_SVD_P_pred_acc2, annotate=T, "prec/rec", legend="bottomright")
#####################################################################
#####################################################################

## IBCF_C
rating_final_eval <- evaluationScheme(data = df,
                              method = "cross-validation",
                              train = 0.8,
                              k = 3,
                              goodRating = 3,
                              given = 20)

# Training dataset modeling ------------------------ (1)
rating_IBCF_C <- Recommender(data = getData(rating_final_eval, "train"),
                           method = "IBCF", 
                           parameter = "Cosine")
rating_IBCF_C
# Prediction
rating_IBCF_C_pred <- predict(rating_IBCF_C, 
                     newdata = getData(rating_final_eval, "known"),
                     n = 10, type = "ratings")
rating_IBCF_C_pred 
# Calculate accuracy
rating_IBCF_C_pred_acc <- calcPredictionAccuracy(x = rating_IBCF_C_pred,
                                        data = getData(rating_final_eval, "unknown"),
                                        byUser = TRUE) # byUser = TRUE : ê° ì‚¬ìš©ìë“¤ì— ëŒ€í•œ ëª¨ë¸ì˜ ì •í™•ë„ê°€ ê³„ì‚°
#head(accuracy_eval, 10)
colMeans(rating_IBCF_C_pred_acc, na.rm=T) #ì •í™•ë„ #################################### ìµœì¢… rmse

rating_IBCF_C_pred_acc2 <- evaluate(x = rating_final_eval, 
                           method = "IBCF",
                           parameter = "Cosine")
head(getConfusionMatrix(rating_IBCF_C_pred_acc2))

plot(rating_IBCF_C_pred_acc)
plot(rating_IBCF_C_pred_acc2, annotate=T, legend="topleft")
plot(rating_IBCF_C_pred_acc2, annotate=T, "prec/rec", legend="bottomright")

```

```{r 2.2 ì¥ë¥´ë°ì´í„°ì¤€ë¹„, eval=FALSE}
#ë°ì´í„°êµ¬ì¶• ------------------------
user_genres <- merge(movies, ratings, key='movieId', all.y=T)
View(user_genres)
user_genres2 <- data.table()
n <- nrow(user_genres)
for (i in 1:n){

  #print(i)

  name_index <- as.character(user_genres[i, 1])
  item_index <- as.character(user_genres[i, 3])
  userId <- as.character(user_genres[i, 4])
  rating <- as.character(user_genres[i, 5])

  item_index_split_temp <- data.frame(strsplit(item_index, split = '\\|'))
  m_temp <- data.frame(cbind(name_index, item_index_split_temp, userId, rating))

  names(m_temp) <- c("movieId", "genres", "userId", "rating")

  user_genres2 <- rbind(user_genres2, m_temp)
}
rm(name_index, item_index, item_index_split_temp, m_temp)
user_genres2$rating <- as.numeric(user_genres2$rating)
user_genres2$genres <- gsub("\\(no genres listed\\)", "Unknown", user_genres2$genres)
user_genres <- as.data.frame(user_genres2)

glimpse(user_genres)
write.csv(user_genres, "./data/user_genres.csv",row.names = F)
View(user_genres)
```
```{r 2.2 ì¥ë¥´CF cross-validation}
#ìœ ì €ë³„ ì¥ë¥´ í‰ê· í‰ì  ê³„ì‚° --------------------------
user_genres <- read.csv("./data/user_genres.csv", header = T)
user_genres <- user_genres[,c(3,2,4)]
head(user_genres)

user_mg <- as(user_genres, "realRatingMatrix")
image(user_mg[1:10, 1:20], main = "Real rating matrix") #sparse
#ë¨¸ì‹ ëŸ¬ë‹ì„ ìœ„í•´ í•™ìŠµë°ì´í„°ì„ ì • -----------------------------------
set.seed(2021)
index <- sample(1:nrow(user_mg), size = nrow(user_mg)*0.8)
train <- user_mg[index, ]
#test setì€ ì¶”ì²œ ë°›ì„ ì‚¬ìš©ìë¦¬ìŠ¤íŠ¸ê°€ ë ê±°ì„
recommenderUserList  <- user_mg[-index,]

#í–‰ì˜ ì´í•© 25ê°œ ì´ìƒì˜ ì•„ì´í…œ(ì˜í™”)ë§Œ ì„ íƒ ------------------------
#ì•„ì´í…œì´ ì ì€ ê²ƒì€ ì™œê³¡ëœ ì¶”ì²œê²°ê³¼ë¥¼ ë³´ë‚´ì¤„ ìˆ˜ ìˆìŒ
train2 <- train[rowCounts(train)>5]
check = as(train2, "matrix")

eval_sets3 <- evaluationScheme(data = train2, 
                              method = "cross-validation",
                              train = .8, 
                              given = 6,
                              goodRating = 3.5, 
                              k = 3)
##ì¶”ì²œëª¨ë¸ìƒì„± -----------------------------------------------------
mg_UBCF <- Recommender(train2, 
                      method = "UBCF",
                      parameter="Cosine")
mg_UBCF

mg_IBCF <- Recommender(train2, 
                      method = "IBCF",
                      parameter="Cosine") # ì‹œê°„ì†Œìš”
mr_IBCF
##ì¶”ì²œëª¨ë¸í‰ê°€ -----------------------------------------------------
#ì¶”ì²œ
UBCFlist3 <- predict(mg_UBCF, recommenderUserList, n=5)
IBCFlist3 <- predict(mg_IBCF, recommenderUserList, n=5)
#ì¶”ì²œ ë°›ì€ ë¦¬ìŠ¤íŠ¸
head(as(UBCFlist3, "list"),2) 
head(as(IBCFlist3, "list"),2)

mr_al_UBCF <- list("user-based CF_Cosine" = list(name="UBCF",
                                                 parameter=
                                                   list(method="Cosine")),
                   "user-based CF_Pearson" = list(name="UBCF",
                                                 parameter=
                                                   list(method="Pearson")))

mr_al_IBCF <- list("item-based CF_Cosine" = list(name="IBCF",
                                                 parameter=
                                                   list(method="Cosine")),
                   "item-based CF_Pearson" = list(name="IBCF",
                                                 parameter=
                                                   list(method="Pearson")))

###########################################################################
###########################################################################
#evaluate() -------------------------------------------------------
result_gu <- evaluate(eval_sets3, mr_al_UBCF, n=c(1,3,5))
result_gu
avg(result_gu)
saveRDS(result_gu, "./data/result_gu.rds") # ì¥ë¥´ ì•Œê³ ë¦¬ì¦˜=mr_al_UBCF

result_gi <- evaluate(eval_sets3, mr_al_IBCF, n=c(1,3,5))
names(result_gi)
avg(result_gi)
saveRDS(result_gi, "./data/result_gi.rds") # ì¥ë¥´ ì•Œê³ ë¦¬ì¦˜=mr_al_IBCF

result_g_al <- evaluate(eval_sets3, algorithms, n=c(1,3,5))
names(result_g_al)
avg(result_g_al)
saveRDS(result_g_al, "./data/result_g_al.rds") # í‰ì  ì•Œê³ ë¦¬ì¦˜=algorithms

########################################################################### ì¥ë¥´ ìµœì¢… ë¹„êµê²°ì •
plot(result_gu, annotate=T, legend="topleft")
plot(result_gu, annotate=T, "prec/rec", legend="bottomright")

plot(result_gi, annotate=T, legend="topleft")
plot(result_gi, annotate=T, "prec/rec", legend="bottomright")

plot(result_al[c(1,3,4,5,6)], annotate=T, legend="topleft")
plot(result_al[c(1,3,4,5,6)], annotate=T, "prec/rec", legend="bottomright")
###########################################################################
###########################################################################
```
```{r 2.2 ì¥ë¥´ì½˜í…ì¸ , eval=FALSE}
#ì˜í™”/ì¥ë¥´ ë²¡í„°í™” --------------------------
mg <- read.csv("./data/mg.csv", header = T)
mg <- mg[,c(2,4,3)]
head(mg)

library(reshape2)
movie_genres <- acast(mg, title ~ genres, value.var = "value")
movie_genres <- as.data.frame(movie_genres)
# final_mg <- spread(mg, key = "genres", value = "value", fill = 0)
# final_mg <- final_mg[,-c(1,2)]

sim_users <- cor(movie_genres[, 1:6], use = "complete.obs")
sim_users
```

# ì¥ë¥´ ìµœì¢…
```{r ì¥ë¥´ ìµœì¢…}
#####################################################################
## SVD_ Pearson ==> Cosine
rating_final_eval <- evaluationScheme(data = df,
                              method = "cross-validation",
                              train = 0.8,
                              k = 3,
                              goodRating = 3,
                              given = 20)

# Training dataset modeling ------------------------ (1)
genre_SVD_P <- Recommender(data = getData(rating_final_eval, "train"),
                           method = "SVD", 
                           parameter = "Pearson")
genre_SVD_P
# Prediction
genre_SVD_P_pred <- predict(genre_SVD_P, 
                     newdata = getData(rating_final_eval, "known"),
                     n = 10, type = "ratings")
genre_SVD_P_pred
# Calculate accuracy
genre_SVD_P_pred_acc <- calcPredictionAccuracy(x = genre_SVD_P_pred,
                                        data = getData(rating_final_eval, "unknown"),
                                        byUser = TRUE) # byUser = TRUE : ê° ì‚¬ìš©ìë“¤ì— ëŒ€í•œ ëª¨ë¸ì˜ ì •í™•ë„ê°€ ê³„ì‚°
#head(accuracy_eval, 10)
colMeans(genre_SVD_P_pred_acc, na.rm=T) #ì •í™•ë„ #################################### ìµœì¢… rmse

genre_SVD_P_pred_acc2 <- evaluate(x = rating_final_eval, 
                           method = "SVD",
                           parameter = "Pearson")
head(getConfusionMatrix(genre_SVD_P_pred_acc2))

plot(genre_SVD_P_pred_acc)
plot(genre_SVD_P_pred_acc2, annotate=T, legend="topleft")
plot(genre_SVD_P_pred_acc2, annotate=T, "prec/rec", legend="bottomright")
#####################################################################
#####################################################################
## IBCF_ Pearson ==>UBCF_ Pearson
rating_final_eval <- evaluationScheme(data = df,
                              method = "cross-validation",
                              train = 0.8,
                              k = 3,
                              goodRating = 3,
                              given = 20)

# Training dataset modeling ------------------------ (1)
genre_IBCF_P <- Recommender(data = getData(rating_final_eval, "train"),
                           method = "IBCF", 
                           parameter = "Pearson")
genre_IBCF_P
# Prediction
genre_IBCF_P_pred <- predict(genre_IBCF_P, 
                     newdata = getData(rating_final_eval, "known"),
                     n = 10, type = "ratings")
genre_IBCF_P_pred
# Calculate accuracy
genre_IBCF_P_pred_acc <- calcPredictionAccuracy(x = genre_IBCF_P_pred,
                                        data = getData(rating_final_eval, "unknown"),
                                        byUser = TRUE) # byUser = TRUE : ê° ì‚¬ìš©ìë“¤ì— ëŒ€í•œ ëª¨ë¸ì˜ ì •í™•ë„ê°€ ê³„ì‚°
#head(accuracy_eval, 10)
colMeans(genre_IBCF_P_pred_acc, na.rm=T) #ì •í™•ë„ #################################### ìµœì¢… rmse

genre_IBCF_P_pred_acc2 <- evaluate(x = rating_final_eval, 
                           method = "IBCF",
                           parameter = "Pearson")
head(getConfusionMatrix(genre_IBCF_P_pred_acc2))

plot(genre_SVD_P_pred_acc)
plot(genre_SVD_P_pred_acc2, annotate=T, legend="topleft")
plot(genre_SVD_P_pred_acc2, annotate=T, "prec/rec", legend="bottomright")
#####################################################################
#####################################################################

genre_SVD_P_pred <- predict(genre_SVD_P, 
                     newdata = getData(rating_final_eval, "known"),
                     n = 10, type = "topNlist")



```


## 2.2. ì¶”ê°€ë¶„ì„ - ì•Œê³ ë¦¬ì¦˜ì— ë”°ë¥¸ ì¶”ì²œ
```{r 2.3 ì•Œê³ ë¦¬ì¦˜}
#ìœ„ ë¶„ì„ ê²°ê³¼ë¡œ ë‚˜ì˜¨ UBCF, IBCF method ê°€ì ¸ì™€ì„œ
algorithms <- 
  list( RANDOM = list(name = "RANDOM", param = NULL),
        POPULAR = list(name = "POPULAR", param = NULL),
        HYBRID = list(name = "HYBRID", param = list(recommenders = 
                 list( RANDOM = list(name = "RANDOM", param = NULL),
                       POPULAR = list(name = "POPULAR", param = NULL)))),
        SVD_C = list(name = "SVD", param = list(method = "cosine")),
        SVD_P = list(name = "SVD", param = list(method = "pearson")),
        HYBRID2 = list(name = "HYBRID", param = list(recommenders = 
                 list( RANDOM = list(name = "UBCF", param = NULL),
                       POPULAR = list(name = "SVD", param = NULL)))),
        HYBRID3 = list(name = "HYBRID", param = list(recommenders = 
                 list( RANDOM = list(name = "IBCF", param = NULL),
                       POPULAR = list(name = "SVD", param = NULL))))    
)
```
```{r í‰ì  ì˜›ë‚  ì½”ë“œ}

# m <- m[order(m$movieId),]
# m$idx <- 1:nrow(m)
# mr <- merge(m, r, key='movieId', all.y=T)
# mr <- mr[,-c(1,7)]
# mr <- mr[,-c(2,3)]
# 
# sum(duplicated(mr)) #[1] 3
# which(duplicated(mr)|duplicated(mr,fromLast=T))
# mr[which(duplicated(mr)|duplicated(mr,fromLast=T)),]
# mr <- mr[-which(duplicated(mr)|duplicated(mr,fromLast=T)),]
# mr <- mr[-c(80209,88669),]
# 
# write.csv(mr, "./data/mr.csv",row.names = F)

mr <- read.csv("./data/mr.csv", header=T)
mr<-mr[,c(2,1,3)]
# final_mr <- spread(mr, key = "title", value = "rating", fill = 0)
# final_mr <- final_mr[,-1]
# df <- as(final_mr, 'matrix') 
df <- as(mr, 'realRatingMatrix')
image(df[1:100, 1:100], main = "Real rating matrix") #sparse

#---------------------------------------
#hist(getRatings(df), main="í‰ì ë¶„í¬") #3ì´í•˜ 0(ë¶€ì •), 3ì´ˆê³¼ 1(ê¸ì •)..

set.seed(2021)
index <- sample(1:nrow(df), size = nrow(df) * 0.8)
train <- df[index, ]
test <- df[-index, ]
dim(train) #488*9719
dim(test)  #122*9719

#--------------------------------------- UBCF
UBCF_mr <- Recommender(data = train, method = "UBCF")
UBCF_mr
UBCF_mr@model$data #Normalized using center on rows.

UBCF_mr_pred <- predict(UBCF_mr, newdata = test, n = 5)
UBCF_mr_pred_list <- sapply(UBCF_mr_pred@items, 
                            function(x) { colnames(df)[x] })

#table(unlist(lapply(UBCF_mr_pred_list, length)))
mean(rowCounts(df)) #1ì¸ë‹¹ í‰ê·  165ê°œì˜ ì˜í™”ë¥¼ í‰ê°€
# df_modify <- df[rowCounts(df) <= 165]
# dim(df_modify) #453*9719
# boxplot(Matrix::rowMeans(df_modify))

# "split" "bootstrap" "cross-validation"
eval_sets <- evaluationScheme(data = df,
                              method = "cross-validation",
                              train = 0.8,
                              k = 3,
                              goodRating = 3,
                              given = 20)

sapply(eval_sets@runsTrain, length) #k

# getData()
# train : í›ˆë ¨ ë°ì´í„°
# known : í…ŒìŠ¤íŠ¸ ë°ì´í„°, ì¶”ì²œì„ êµ¬ì¶•í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì•„ì´í…œìœ¼ë¡œ êµ¬ì„±
# unknown : í…ŒìŠ¤íŠ¸ ë°ì´í„°, ì¶”ì²œì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì•„ì´í…œìœ¼ë¡œ êµ¬ì„±

# Recommender() 
# í•¨ìˆ˜ë¥¼ ëª¨ë¸ë§ í›„, predict() í•¨ìˆ˜ë¡œ ratings ê°’ì„ êµ¬í•œ ë‹¤ìŒ calcPredictionAccuracy() í•¨ìˆ˜ë¥¼ í†µí•´ ëª¨ë¸ì˜ ì •í™•ë„ ë©”íŠ¸ë¦­ì„ ê³„ì‚°

# Training dataset modeling ------------------------ (1)
UBCF_eval <- Recommender(data = getData(eval_sets, "train"),
                           method = "UBCF", 
                           parameter = NULL)
UBCF_eval
# Prediction
UBCF_eval_pred <- predict(UBCF_eval, 
                     newdata = getData(eval_sets, "known"),
                     n = 10, type = "ratings")
UBCF_eval_pred
# Calculate accuracy
accuracy_eval <- calcPredictionAccuracy(x = UBCF_eval_pred,
                                        data = getData(eval_sets, "unknown"),
                                        byUser = TRUE) # byUser = TRUE : ê° ì‚¬ìš©ìë“¤ì— ëŒ€í•œ ëª¨ë¸ì˜ ì •í™•ë„ê°€ ê³„ì‚°
#head(accuracy_eval, 10)
colMeans(accuracy_eval, na.rm=T) #ì •í™•ë„
accuracy_eval2 <- evaluate(x = eval_sets, 
                           method = "UBCF")
head(getConfusionMatrix(accuracy_eval2))

#--------------------------------------- IBCF
IBCF_mr <- Recommender(data = train, 
                             method = "IBCF",
                             parameter = list(k = 30))
IBCF_mr
str(getModel(IBCF_mr))
# Prediction
IBCF_mr_pred <- predict(IBCF_mr, newdata = test, n = 10)
IBCF_mr_pred_list <- sapply(IBCF_mr_pred@items, 
                     function(x) { colnames(df)[x] })
# Calculate accuracy
eval_sets2 <- evaluationScheme(data = df,
                               method = "cross-validation",
                               train = 0.8,
                               k = 3,
                               goodRating = 3,
                               given = 20)
# Training dataset modeling ------------------------ (2)
IBCF_eval <- Recommender(data = getData(eval_sets2, "train"),
                            method = "IBCF", 
                            parameter = NULL)
IBCF_eval
# Prediction
IBCF_eval_pred <- predict(IBCF_eval, 
                      newdata = getData(eval_sets2, "known"),
                      n = 10, type = "ratings")
IBCF_eval_pred
# Calculate accuracy
accuracy_eval3 <- calcPredictionAccuracy(x = IBCF_eval_pred,
                                         data = getData(eval_sets2, "unknown"),
                                         byUser = TRUE) # byUser = TRUE : ê° ì‚¬ìš©ìë“¤ì— ëŒ€í•œ ëª¨ë¸ì˜ ì •í™•ë„ê°€ ê³„ì‚°
colMeans(accuracy_eval3, na.rm=T) #ì •í™•ë„
accuracy_eval4 <- evaluate(x = eval_sets2, 
                           method = "IBCF", 
                           n = seq(10, 100, by = 10))
#head(getConfusionMatrix(accuracy_eval4))

plot(accuracy_eval2, annotate = TRUE, main = "ROC Curve")
plot(accuracy_eval4, annotate = TRUE, main = "ROC Curve")
plot(accuracy_eval2, "prec/rec", annotate = TRUE, main = "Precision-Recall")
plot(accuracy_eval4, "prec/rec", annotate = TRUE, main = "Precision-Recall")

plot(accuracy_eval, main = " ")
plot(accuracy_eval3, main = " ")


##################################################################################
#--------------------------------------- ë§¤ê°œë³€ìˆ˜ íŠœë‹
# IBCF ëª¨í˜•ì„ êµ¬ì¶•í•˜ëŠ” ê³¼ì •ì—ì„œ ìµœì¢…ì  ëª¨í˜•ì„ êµ¬ì¶•í•˜ê¸° ìœ„í•´ ëª‡ ê°€ì§€ ìµœì ì˜ ê°’ì„ ì„ íƒí•´ì•¼ í•œë‹¤.
# - ì•„ì´í…œ ê°„ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•˜ëŠ” ë° ì´ì›ƒì˜ ìˆ˜ì— ëŒ€í•œ ìµœì ì˜ ê°’
# - ì½”ì‚¬ì¸ ë˜ëŠ” í”¼ì–´ìŠ¨ ìƒê´€ê³„ìˆ˜ ì¤‘ ìœ ì‚¬ë„ ê³„ì‚° ê¸°ì¤€ ì„ íƒ
# - ë”°ë¼ì„œ kê°’ì´ ë  ìˆ˜ ìˆëŠ” í›„ë³´êµ°ì„ ë²¡í„°ë¡œ ì„¤ì •
vector_k <- c(5, 10, 20, 30, 40)
mod1 <- lapply(vector_k, function(k, l) { 
  list(name = "IBCF", parameter = list(method = "cosine", k = k)) 
  })
names(mod1) <- paste0("IBCF_cos_k_", vector_k)
names(mod1)
mod2 <- lapply(vector_k, function(k, l) { 
  list(name = "IBCF", parameter = list(method = "pearson", k = k)) 
  })
names(mod2) <- paste0("IBCF_pea_k_", vector_k)
names(mod2)

mod <- append(mod1, mod2) # vector merging

# ì‹œê°„ ì†Œìš” (many)
list_results <- evaluate(x = eval_sets2, 
                         method = mod,
                         n = c(1, 5, seq(10, 100, by=10)))

plot(list_results, annotate = c(1, 2), legend = "topleft")
title("ROC Curve")
plot(list_results, "prec/rec", annotate = 1, legend = "bottomright")
title("Precision-Recall")
```
```{r í™•ì¸, eval=FALSE}
#--------------------------------------- 
# split
unique(rowCounts(getData(eval_sets, "known")))
qplot(rowCounts(getData(eval_sets, "unknown"))) +
  geom_histogram(binwidth = 10) +
  ggtitle("unknown items by the users")

# bootstrap
table_train <- table(eval_sets@runsTrain[[1]])
n_repetitions <- factor(as.vector(table_train))
qplot(n_repetitions) + ggtitle("Number of repetitions in the traing set")

#ì¶”ì²œ ê²°ê³¼ í‰ê°€ ì‹œê°í™” ------------------------
#ì˜ˆì¸¡ í‰ì  í‰ê°€

qplot(rowCounts(eval_prediction)) +
  geom_histogram(binwidth = 10) + 
  ggtitle("Distribution of movies per user")

eval_accuracy <- calcPredictionAccuracy(x = eval_prediction, 
                                        data = getData(eval_sets, "unknown"), 
                                        byUser = TRUE)
head(eval_accuracy)
qplot(eval_accuracy[, "RMSE"]) +
  geom_histogram(binwidth = 0.1) +
  ggtitle("Distribution of the RMSE by user")

eval_accuracy <- calcPredictionAccuracy(x = eval_prediction, 
                                        data = getData(eval_sets, "unknown"), 
                                        byUser = FALSE)
eval_accuracy

#ì¶”ì²œ ê²°ê³¼ í‰ê°€ ------------------------

head(getConfusionMatrix(results)[[1]])

columns_to_sum <- c("TP", "FP", "FN", "TN")
indices_summed <- Reduce("+", getConfusionMatrix(results))[, columns_to_sum]
head(indices_summed)

plot(results, annotate = TRUE, main = "ROC curve")
plot(results, "prec/rec", annotate = TRUE, main = "Precision-recall")

#ê°€ì¥ ì¢‹ì€ ì„±ëŠ¥ì„ ê°€ì§€ëŠ” ëª¨ë¸ ì„ íƒ ------------------------
models_to_evaluate <- list(
  IBCF_cos = list(name = "IBCF", param = list(method = "cosine")),
  IBCF_cor = list(name = "IBCF", param = list(method = "pearson")),
  UBCF_cos = list(name = "UBCF", param = list(method = "cosine")),
  UBCF_cor = list(name = "UBCF", param = list(method = "pearson")),
  SVD_cor = list(name = "SVD", param = list(method = "cosine")),
  random = list(name = "RANDOM", param = NULL))

n_recommendations <- c(1, 5, seq(10, 100, 10))

list_results <- evaluate(x = eval_sets, 
                         method = models_to_evaluate, 
                         n = n_recommendations)

sapply(list_results, class) == "evaluationResults"
avg_matrices <- lapply(list_results, avg)
head(avg_matrices$IBCF_cos[, 5:8])
```

</br></br>

---

</br></br>

## 3. ì¶”ì²œì˜í™” ì‹œê°í™”

```{r ì‹œê°í™”, eval=FALSE}
# ìµœì¢… ê²°ê³¼ predict ê²°ê³¼ ê°€ì§€ê³ .
# UBCF_mr_pred ------------------------
min_rating <- min(IBCF_mr_pred@ratings[[1]])
max_rating <- max(IBCF_mr_pred@ratings[[1]])
e_value <- (max_rating-min_rating)/10

pre_list <- sapply(IBCF_mr_pred@items, function(x) {colnames(train)[x]})
table(unlist(lapply(pre_list, length)))
knitr::kable(pre_list[])

pre_ratings <- IBCF_mr_pred@ratings[[1]]

n=10
for(i in 1:n){
  
  if(pre_ratings[i] <= max_rating && pre_ratings[i] > max_rating-e_value)
    { pre_ratings[i] <- 100 } #ê°€ì¤‘ì¹˜ 100
  
  else if(pre_ratings[i] <= max_rating-e_value && pre_ratings[i] > max_rating-e_value*2)
    { pre_ratings[i] <- 90 }  #ê°€ì¤‘ì¹˜ 90
  
  else if(pre_ratings[i] <= max_rating-e_value*2 && pre_ratings[i] > max_rating-e_value*4)
    { pre_ratings[i] <- 70 }  #ê°€ì¤‘ì¹˜ 70
  
  else if(pre_ratings[i] <= max_rating-e_value*4 && pre_ratings[i] > max_rating-e_value*6)
    { pre_ratings[i] <- 50 }  #ê°€ì¤‘ì¹˜ 50
  
  else { pre_ratings[i] <- 25 }

}

# ì›Œë“œí´ë¼ìš°ë“œ
pre_vec <- c(pre_list)
pre_vec <- as.data.frame(pre_vec)
pre_vec[ , "freq" ] <- c(pre_ratings)
set.seed(1234)
par(bg="black")
pal<- brewer.pal(7,"YlOrRd")
wordcloud(words = pre_vec$pre_vec,              # ë‹¨ì–´ 
                         freq = pre_vec$freq,   # ë¹ˆë„
                         min.freq = 25,         # ìµœì†Œ ë‹¨ì–´ ë¹ˆë„
                         max.words = 300,       # í‘œí˜„ ë‹¨ì–´ ìˆ˜ 
                         random.order = F,      # ê³ ë¹ˆë„ ë‹¨ì–´ ì¤‘ì•™ ë°°ì¹˜
                         rot.per = 0,           # íšŒì „ ë‹¨ì–´ ë¹„ìœ¨ 
                         scale = c(1, 0.25),    # ë‹¨ì–´ í¬ê¸° ë²”ìœ„
                         colors = pal)          # ìƒ‰ê¹” ëª©ë¡
```

</br></br>

---

  - Rê³¼ R shinyë¥¼ í™œìš©í•œ ì¶”ì²œì‹œìŠ¤í…œ êµ¬í˜„
  - íŒ¨í‚¤ì§€ ë‚´ ë‹¤ì–‘í•œ í•¨ìˆ˜ë“¤ì„ ë³´ë‹¤ ì ì ˆí•˜ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì´ë¡  í•™ìŠµì´ í•„ìš”í•˜ë‹¤.

  - ìœ„ íŒ¨í‚¤ì§€ëŠ” ì§€ì†ì ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œê°€ ë˜ê³  ìˆê¸° ë•Œë¬¸ì— [Reference Manual](https://cran.r-project.org/web/packages/recommenderlab/recommenderlab.pdf)ì„ í™œìš©í•œë‹¤.